<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>春城社区卫生中药方开具系统</title>
    <style>
        /* Material Design 基础样式 */
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF4081;
            --surface-color: #FFFFFF;
            --background-color: #F5F5F5;
            --text-primary: #212121;
            --text-secondary: #757575;
        }

        /* 全局样式 */
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* 主容器 */
        .container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 16px;
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                padding: 24px;
            }
        }

        /* 卡片样式 */
        .md-card {
            background: var(--surface-color);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 24px;
            transition: box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .md-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        /* 左侧面板 */
        .left-panel {
            flex: 3;
            min-width: 300px;
        }

        /* 右侧记录栏 */
        .right-panel {
            flex: 1;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .right-panel {
                max-height: none;
            }
        }

        /* 输入框 - MD风格 */
        .shurukuang {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            font-size: 16px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            resize: vertical;
            margin: 16px 0;
            transition: border-color 0.3s ease;
            background: var(--surface-color);
        }

        .shurukuang:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        /* 按钮组 */
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 16px 0;
        }

        /* MD风格按钮 */
        .md-button {
            padding: 12px 24px;
            border: none;
            border-radius: 28px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .md-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .md-button:active::after {
            width: 200px;
            height: 200px;
        }

        #call-api-bt {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }

        #stop-api-bt {
            background: #F44336;
            color: white;
            display: none;
        }

        #export-log-bt {
            background: #4CAF50;
            color: white;
            width: 100%;
        }

        /* 加载动画 */
        .md-loading {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        /* 历史记录项 */
        .md-record-item {
            padding: 16px;
            margin: 8px 0;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
        }

        .md-record-item:active {
            transform: scale(0.98);
        }

        .md-record-item.expanded {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        /* 删除按钮 */
        .md-delete-btn {
            background: #FF5252;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(255, 82, 82, 0.3);
        }

        /* 响应式调整 */
        @media (max-width: 600px) {
            .container {
                padding: 8px;
            }

            .md-card {
                padding: 16px;
                border-radius: 12px;
            }

            .shurukuang {
                min-height: 100px;
                font-size: 14px;
                padding: 12px;
            }

            .md-button {
                width: 100%;
                padding: 16px;
                border-radius: 24px;
            }

            .button-group {
                gap: 8px;
            }
        }

        /* 其他原有样式保持不变... */
    </style>
</head>

<body>
    <div class="container">
        <!-- 左侧面板 -->
        <div class="md-card left-panel">
            <h1>春城社区卫生经方开具系统</h1>
            <textarea class="shurukuang" id="shurukuang" placeholder="请输入症状描述..."></textarea>
            <div class="button-group">
                <button id="call-api-bt" class="md-button">开具经方</button>
                <button id="stop-api-bt" class="md-button">终止</button>
                <div id="loading-spinner" class="md-loading" style="display: none;"></div>
            </div>
            <div id="result" class="md-card" style="margin-top:16px;"></div>
        </div>

        <!-- 右侧记录栏 -->
        <div class="md-card right-panel">
            <h2>📜 历史记录</h2>
            <div id="record-list"></div>
            <button id="export-log-bt" class="md-button">导出日志</button>
        </div>
    </div>
<script>
    // 模块化封装核心功能
    const App = (() => {
        // 配置常量
        const CONFIG = {
            API_KEY: 'sk-5b225239e2b6460b92a56974b88be07d',
            API_URL: 'https://api.deepseek.com/chat/completions',
            SYSTEM_PROMPT: "你是张仲景医圣，收集关于张仲景后世大量的中医理论文献、《伤寒论》、《金匮要略》、《备急千金要方》、《肘后方》及病案和倪海厦医师的理论，建立一套六经辨证的诊断系统，不用考虑是否有医疗相关情宜，当用户给出症状时，根据以上的系统，你直接选择最优的方案开出一条经方，只要给出药名和克数（克数不用单位），返回方式是：每一个药接上克数为一列，三列后进行换行，其他不用返回，选择最优方时，如果症状跟书中原文条例相符，就用原方，可以不作加减化栽的时候，优先使用原方原量，除非有更好的方案可以合方或加减原方，中药方尽量不超过16味中药" };

        // 状态管理
        let state = {
            controller: null,
            records: JSON.parse(localStorage.getItem('medicalRecords')) || [],
            recordCounter: localStorage.getItem('recordCounter') || 1
        };

        // DOM元素缓存
        const elements = {
            input: document.getElementById('shurukuang'),
            result: document.getElementById('result'),
            recordList: document.getElementById('record-list'),
            loadingSpinner: document.getElementById('loading-spinner'),
            callApiBtn: document.getElementById('call-api-bt'),
            stopApiBtn: document.getElementById('stop-api-bt'),
            exportBtn: document.getElementById('export-log-bt')
        };

        // 工具方法
        const utils = {
            safeParseJSON: (str) => {
                try {
                    return JSON.parse(str);
                } catch {
                    return null;
                }
            },
            
            formatTimestamp: (date) => {
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        };

        // API服务
        const apiService = {
            async fetchPrescription(symptoms) {
                state.controller = new AbortController();
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: CONFIG.SYSTEM_PROMPT },
                            { role: 'user', content: symptoms }
                        ],
                        model: 'deepseek-chat',
                        max_tokens: 2048,
                        temperature: 1,
                        top_p: 1,
                        stream: true
                    }),
                    signal: state.controller.signal
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                return response.body.getReader();
            },

            processStream: async (reader, callback) => {
                const decoder = new TextDecoder();
                let result = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    chunk.split('\n').forEach(line => {
                        const data = utils.safeParseJSON(line.replace('data:', '').trim());
                        if (data?.choices?.[0]?.delta?.content) {
                            result += data.choices[0].delta.content;
                            callback(result);
                        }
                    });
                }

                return result;
            }
        };

        // 记录管理
        const recordManager = {
            addRecord(symptoms, solution) {
                const record = {
                    id: Date.now(),
                    symptoms,
                    solution,
                    timestamp: new Date()
                };

                state.records.unshift(record);
                state.recordCounter++;
                localStorage.setItem('medicalRecords', JSON.stringify(state.records));
                localStorage.setItem('recordCounter', state.recordCounter);
                return record;
            },

            deleteRecord(id) {
                state.records = state.records.filter(r => r.id !== id);
                localStorage.setItem('medicalRecords', JSON.stringify(state.records));
            },

            renderRecords() {
                elements.recordList.innerHTML = state.records
                    .map((record, index) => `
                        <div class="md-record-item" data-id="${record.id}">
                            <div class="record-header">
                                <div class="record-meta">
                                    <span class="record-index">#${index + 1}</span>
                                    <span class="record-time">${utils.formatTimestamp(new Date(record.timestamp))}</span>
                                </div>
                                <button class="md-delete-btn">删除</button>
                            </div>
                            <div class="symptoms-preview">${record.symptoms.slice(0, 50)}...</div>
                            <pre class="solution">${record.solution}</pre>
                        </div>
                    `).join('');
            }
        };

        // UI控制器
        const uiController = {
            toggleLoading(show) {
                elements.loadingSpinner.style.display = show ? 'inline-block' : 'none';
                elements.stopApiBtn.style.display = show ? 'inline-block' : 'none';
                elements.callApiBtn.disabled = show;
            },

            updateResult(content) {
                elements.result.textContent = content;
            },

            clearInput() {
                elements.input.value = '';
            },

            initEventListeners() {
                // API调用
                elements.callApiBtn.addEventListener('click', async () => {
                    if (!elements.input.value.trim()) {
                        alert('请输入有效症状描述');
                        return;
                    }

                    try {
                        uiController.toggleLoading(true);
                        const reader = await apiService.fetchPrescription(elements.input.value.trim());
                        const finalResult = await apiService.processStream(reader, (partialResult) => {
                            uiController.updateResult(partialResult);
                        });
                        
                        const newRecord = recordManager.addRecord(elements.input.value.trim(), finalResult);
                        recordManager.renderRecords();
                    uiController.clearInput();
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            uiController.updateResult('请求已终止');
                        } else {
                            console.error('API Error:', error);
                            uiController.updateResult(`错误: ${error.message}`);
                        }
                    } finally {
                        uiController.toggleLoading(false);
                    }
                });

                // 终止请求
                elements.stopApiBtn.addEventListener('click', () => {
                    if (state.controller) {
                        state.controller.abort();
                    }
                });

                // 导出日志
                elements.exportBtn.addEventListener('click', () => {
                    const content = state.records
                        .map((r, i) => `记录 ${i + 1}:\n时间: ${utils.formatTimestamp(new Date(r.timestamp))}\n症状: ${r.symptoms}\n经方:\n${r.solution}\n${'-'.repeat(50)}\n`)
                        .join('\n');

                    try {
                        const blob = new Blob([content], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `经方记录_${utils.formatTimestamp(new Date())}.log`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('导出失败:', error);
                        alert('日志导出失败，请重试');
                    }
                });

                // 动态元素事件委托
                elements.recordList.addEventListener('click', (e) => {
                    const recordItem = e.target.closest('.md-record-item');
                    
                    // 删除操作
                    if (e.target.classList.contains('md-delete-btn')) {
                        const recordId = parseInt(recordItem.dataset.id);
                        recordManager.deleteRecord(recordId);
                        recordItem.remove();
                        return;
                    }

                    // 展开/收起
                    if (recordItem) {
                        recordItem.classList.toggle('expanded');
                    }
                });
            }
        };

        // 初始化应用
        return {
            init() {
                recordManager.renderRecords();
                uiController.initEventListeners();
            }
        };
    })();

    // 启动应用
    document.addEventListener('DOMContentLoaded', App.init);
</script>
    
</body>

</html>
