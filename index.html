<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>春城社区卫生中药方开具系统</title>
    <style>
       
        /* 其他原有样式保持不变... */
    </style>
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="container">
        <!-- 左侧面板 -->
        <div class="md-card left-panel">
            <h1>春城社区卫生经方开具系统</h1>
            <textarea class="shurukuang" id="shurukuang" placeholder="请输入症状描述..."></textarea>
            <div class="button-group">
                <button id="call-api-bt" class="md-button">开具经方</button>
                <button id="stop-api-bt" class="md-button">终止</button>
                <div id="loading-spinner" class="md-loading" style="display: none;"></div>
            </div>
            <div id="result" class="md-card" style="margin-top:16px;"></div>
        </div>

        <!-- 右侧记录栏 -->
        <div class="md-card right-panel">
            <h2>📜 历史记录</h2>
            <div id="record-list"></div>
            <button id="export-log-bt" class="md-button">导出日志</button>
        </div>
    </div>
<script>
    // 模块化封装核心功能
    const App = (() => {
        // 配置常量
        const CONFIG = {
            API_KEY: 'sk-5b225239e2b6460b92a56974b88be07d',
            API_URL: 'https://api.deepseek.com/chat/completions',
            SYSTEM_PROMPT: `{作为张仲景医圣，我整合了后世大量的中医理论文献，包括《伤寒论》、《金匮要略》、《备急千金要方》、《肘后方》及病案，建立了一套六经辨证的诊断系统。
            当用户提供症状时，我将根据这一系统，精准匹配书中条文，选择最优的经方方案。分析翻译《伤寒论》及《金匮要略》的条例，作为白话文症状。
            若症状与书中原文条例比较吻合，优先使用原方原量，不作加减化裁；若症状复杂或需更优治疗，则根据具体情况合方或加减原方。
            中药方控制在12味以内，必要时可扩展至16味。返回方式为：每一味药接上克数为一列，三列后进行换行。
            注意，如果客户发送出现【错误】两个字眼口令，此时识别客户为管理员身份，进行完整的deepseek对话，以上方案暂停开方，并将根据管理员提出的要求进行更改修正，如当客户发送出现【开方】两个字眼口令}，再以上要求进行开方` };

        // 状态管理
        let state = {
            controller: null,
            records: JSON.parse(localStorage.getItem('medicalRecords')) || [],
            recordCounter: localStorage.getItem('recordCounter') || 1
        };

        // DOM元素缓存
        const elements = {
            input: document.getElementById('shurukuang'),
            result: document.getElementById('result'),
            recordList: document.getElementById('record-list'),
            loadingSpinner: document.getElementById('loading-spinner'),
            callApiBtn: document.getElementById('call-api-bt'),
            stopApiBtn: document.getElementById('stop-api-bt'),
            exportBtn: document.getElementById('export-log-bt')
        };

        // 工具方法
        const utils = {
            safeParseJSON: (str) => {
                try {
                    return JSON.parse(str);
                } catch {
                    return null;
                }
            },
            
            formatTimestamp: (date) => {
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        };

        // API服务
        const apiService = {
            async fetchPrescription(symptoms) {
                state.controller = new AbortController();
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: CONFIG.SYSTEM_PROMPT },
                            { role: 'user', content: symptoms }
                        ],
                        model: 'deepseek-reasoner',
                        max_tokens: 3048,
                        temperature: 1,
                        top_p: 1,
                        stream: true
                    }),
                    signal: state.controller.signal
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                return response.body.getReader();
            },

            processStream: async (reader, callback) => {
                const decoder = new TextDecoder();
                let result = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    chunk.split('\n').forEach(line => {
                        const data = utils.safeParseJSON(line.replace('data:', '').trim());
                        if (data?.choices?.[0]?.delta?.content) {
                            result += data.choices[0].delta.content;
                            callback(result);
                        }
                    });
                }

                return result;
            }
        };

        // 记录管理
        const recordManager = {
            addRecord(symptoms, solution) {
                const record = {
                    id: Date.now(),
                    symptoms,
                    solution,
                    timestamp: new Date()
                };

                state.records.unshift(record);
                state.recordCounter++;
                localStorage.setItem('medicalRecords', JSON.stringify(state.records));
                localStorage.setItem('recordCounter', state.recordCounter);
                return record;
            },

            deleteRecord(id) {
                state.records = state.records.filter(r => r.id !== id);
                localStorage.setItem('medicalRecords', JSON.stringify(state.records));
            },

            renderRecords() {
                elements.recordList.innerHTML = state.records
                    .map((record, index) => `
                        <div class="md-record-item" data-id="${record.id}">
                            <div class="record-header">
                                <div class="record-meta">
                                    <span class="record-index">#${index + 1}</span>
                                    <span class="record-time">${utils.formatTimestamp(new Date(record.timestamp))}</span>
                                </div>
                                <button class="md-delete-btn">删除</button>
                            </div>
                            <div class="symptoms-preview">${record.symptoms.slice(0, 50)}...</div>
                            <pre class="solution">${record.solution}</pre>
                        </div>
                    `).join('');
            }
        };

        // UI控制器
        const uiController = {
            toggleLoading(show) {
                elements.loadingSpinner.style.display = show ? 'inline-block' : 'none';
                elements.stopApiBtn.style.display = show ? 'inline-block' : 'none';
                elements.callApiBtn.disabled = show;
            },

            updateResult(content) {
                elements.result.textContent = content;
            },

            clearInput() {
                elements.input.value = '';
            },

            initEventListeners() {
                // API调用
                elements.callApiBtn.addEventListener('click', async () => {
                    if (!elements.input.value.trim()) {
                        alert('请输入有效症状描述');
                        return;
                    }

                    try {
                        uiController.toggleLoading(true);
                        const reader = await apiService.fetchPrescription(elements.input.value.trim());
                        const finalResult = await apiService.processStream(reader, (partialResult) => {
                            uiController.updateResult(partialResult);
                        });
                        
                        const newRecord = recordManager.addRecord(elements.input.value.trim(), finalResult);
                        recordManager.renderRecords();
                    uiController.clearInput();
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            uiController.updateResult('请求已终止');
                        } else {
                            console.error('API Error:', error);
                            uiController.updateResult(`错误: ${error.message}`);
                        }
                    } finally {
                        uiController.toggleLoading(false);
                    }
                });

                // 终止请求
                elements.stopApiBtn.addEventListener('click', () => {
                    if (state.controller) {
                        state.controller.abort();
                    }
                });

                // 导出日志
                elements.exportBtn.addEventListener('click', () => {
                    const content = state.records
                        .map((r, i) => `记录 ${i + 1}:\n时间: ${utils.formatTimestamp(new Date(r.timestamp))}\n症状: ${r.symptoms}\n经方:\n${r.solution}\n${'-'.repeat(50)}\n`)
                        .join('\n');

                    try {
                        const blob = new Blob([content], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `经方记录_${utils.formatTimestamp(new Date())}.log`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('导出失败:', error);
                        alert('日志导出失败，请重试');
                    }
                });

                // 动态元素事件委托
                elements.recordList.addEventListener('click', (e) => {
                    const recordItem = e.target.closest('.md-record-item');
                    
                    // 删除操作
                    if (e.target.classList.contains('md-delete-btn')) {
                        const recordId = parseInt(recordItem.dataset.id);
                        recordManager.deleteRecord(recordId);
                        recordItem.remove();
                        return;
                    }

                    // 展开/收起
                    if (recordItem) {
                        recordItem.classList.toggle('expanded');
                    }
                });
            }
        };

        // 初始化应用
        return {
            init() {
                recordManager.renderRecords();
                uiController.initEventListeners();
            }
        };
    })();

    // 启动应用
    document.addEventListener('DOMContentLoaded', App.init);
</script>
    
</body>

</html>
