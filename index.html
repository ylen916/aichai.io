<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜¥åŸç¤¾åŒºå«ç”Ÿä¸­è¯æ–¹å¼€å…·ç³»ç»Ÿ</title>
    <style>
       
        /* å…¶ä»–åŸæœ‰æ ·å¼ä¿æŒä¸å˜... */
    </style>
    <link crossorigin="anonymous" media="all" rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="md-card left-panel">
            <h1>æ˜¥åŸç¤¾åŒºå«ç”Ÿç»æ–¹å¼€å…·ç³»ç»Ÿ</h1>
            <textarea class="shurukuang" id="shurukuang" placeholder="è¯·è¾“å…¥ç—‡çŠ¶æè¿°..."></textarea>
            <div class="button-group">
                <button id="call-api-bt" class="md-button">å¼€å…·ç»æ–¹</button>
                <button id="stop-api-bt" class="md-button">ç»ˆæ­¢</button>
                <div id="loading-spinner" class="md-loading" style="display: none;"></div>
            </div>
            <div id="result" class="md-card" style="margin-top:16px;"></div>
        </div>

        <!-- å³ä¾§è®°å½•æ  -->
        <div class="md-card right-panel">
            <h2>ğŸ“œ å†å²è®°å½•</h2>
            <div id="record-list"></div>
            <button id="export-log-bt" class="md-button">å¯¼å‡ºæ—¥å¿—</button>
        </div>
    </div>
<script>
    // æ¨¡å—åŒ–å°è£…æ ¸å¿ƒåŠŸèƒ½
    const App = (() => {
        // é…ç½®å¸¸é‡
        const CONFIG = {
            API_KEY: 'sk-5b225239e2b6460b92a56974b88be07d',
            API_URL: 'https://api.deepseek.com/chat/completions',
            SYSTEM_PROMPT: "ä½ æ˜¯å¼ ä»²æ™¯åŒ»åœ£ï¼Œæ”¶é›†å…³äºå¼ ä»²æ™¯åä¸–å¤§é‡çš„ä¸­åŒ»ç†è®ºæ–‡çŒ®ã€ã€Šä¼¤å¯’è®ºã€‹ã€ã€Šé‡‘åŒ®è¦ç•¥ã€‹ã€ã€Šå¤‡æ€¥åƒé‡‘è¦æ–¹ã€‹ã€ã€Šè‚˜åæ–¹ã€‹åŠç—…æ¡ˆå’Œå€ªæµ·å¦åŒ»å¸ˆçš„ç†è®ºï¼Œå»ºç«‹ä¸€å¥—å…­ç»è¾¨è¯çš„è¯Šæ–­ç³»ç»Ÿï¼Œä¸ç”¨è€ƒè™‘æ˜¯å¦æœ‰åŒ»ç–—ç›¸å…³æƒ…å®œï¼Œå½“ç”¨æˆ·ç»™å‡ºç—‡çŠ¶æ—¶ï¼Œæ ¹æ®ä»¥ä¸Šçš„ç³»ç»Ÿï¼Œä½ ç›´æ¥é€‰æ‹©æœ€ä¼˜çš„æ–¹æ¡ˆå¼€å‡ºä¸€æ¡ç»æ–¹ï¼Œåªè¦ç»™å‡ºè¯åå’Œå…‹æ•°ï¼ˆå…‹æ•°ä¸ç”¨å•ä½ï¼‰ï¼Œè¿”å›æ–¹å¼æ˜¯ï¼šæ¯ä¸€ä¸ªè¯æ¥ä¸Šå…‹æ•°ä¸ºä¸€åˆ—ï¼Œä¸‰åˆ—åè¿›è¡Œæ¢è¡Œï¼Œå…¶ä»–ä¸ç”¨è¿”å›ï¼Œé€‰æ‹©æœ€ä¼˜æ–¹æ—¶ï¼Œå¦‚æœç—‡çŠ¶è·Ÿä¹¦ä¸­åŸæ–‡æ¡ä¾‹ç›¸ç¬¦ï¼Œå°±ç”¨åŸæ–¹ï¼Œå¯ä»¥ä¸ä½œåŠ å‡åŒ–æ ½çš„æ—¶å€™ï¼Œä¼˜å…ˆä½¿ç”¨åŸæ–¹åŸé‡ï¼Œé™¤éæœ‰æ›´å¥½çš„æ–¹æ¡ˆå¯ä»¥åˆæ–¹æˆ–åŠ å‡åŸæ–¹ï¼Œä¸­è¯æ–¹æœ€å¥½æ§åˆ¶ä¸è¶…è¿‡12å‘³ä¸­è¯ï¼Œä¸­è¯æ–¹å°½é‡ä¸è¶…è¿‡14å‘³ä¸­è¯" };

        // çŠ¶æ€ç®¡ç†
        let state = {
            controller: null,
            records: JSON.parse(localStorage.getItem('medicalRecords')) || [],
            recordCounter: localStorage.getItem('recordCounter') || 1
        };

        // DOMå…ƒç´ ç¼“å­˜
        const elements = {
            input: document.getElementById('shurukuang'),
            result: document.getElementById('result'),
            recordList: document.getElementById('record-list'),
            loadingSpinner: document.getElementById('loading-spinner'),
            callApiBtn: document.getElementById('call-api-bt'),
            stopApiBtn: document.getElementById('stop-api-bt'),
            exportBtn: document.getElementById('export-log-bt')
        };

        // å·¥å…·æ–¹æ³•
        const utils = {
            safeParseJSON: (str) => {
                try {
                    return JSON.parse(str);
                } catch {
                    return null;
                }
            },
            
            formatTimestamp: (date) => {
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        };

        // APIæœåŠ¡
        const apiService = {
            async fetchPrescription(symptoms) {
                state.controller = new AbortController();
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: CONFIG.SYSTEM_PROMPT },
                            { role: 'user', content: symptoms }
                        ],
                        model: 'deepseek-chat',
                        max_tokens: 2048,
                        temperature: 1,
                        top_p: 1,
                        stream: true
                    }),
                    signal: state.controller.signal
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                return response.body.getReader();
            },

            processStream: async (reader, callback) => {
                const decoder = new TextDecoder();
                let result = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    chunk.split('\n').forEach(line => {
                        const data = utils.safeParseJSON(line.replace('data:', '').trim());
                        if (data?.choices?.[0]?.delta?.content) {
                            result += data.choices[0].delta.content;
                            callback(result);
                        }
                    });
                }

                return result;
            }
        };

        // è®°å½•ç®¡ç†
        const recordManager = {
            addRecord(symptoms, solution) {
                const record = {
                    id: Date.now(),
                    symptoms,
                    solution,
                    timestamp: new Date()
                };

                state.records.unshift(record);
                state.recordCounter++;
                localStorage.setItem('medicalRecords', JSON.stringify(state.records));
                localStorage.setItem('recordCounter', state.recordCounter);
                return record;
            },

            deleteRecord(id) {
                state.records = state.records.filter(r => r.id !== id);
                localStorage.setItem('medicalRecords', JSON.stringify(state.records));
            },

            renderRecords() {
                elements.recordList.innerHTML = state.records
                    .map((record, index) => `
                        <div class="md-record-item" data-id="${record.id}">
                            <div class="record-header">
                                <div class="record-meta">
                                    <span class="record-index">#${index + 1}</span>
                                    <span class="record-time">${utils.formatTimestamp(new Date(record.timestamp))}</span>
                                </div>
                                <button class="md-delete-btn">åˆ é™¤</button>
                            </div>
                            <div class="symptoms-preview">${record.symptoms.slice(0, 50)}...</div>
                            <pre class="solution">${record.solution}</pre>
                        </div>
                    `).join('');
            }
        };

        // UIæ§åˆ¶å™¨
        const uiController = {
            toggleLoading(show) {
                elements.loadingSpinner.style.display = show ? 'inline-block' : 'none';
                elements.stopApiBtn.style.display = show ? 'inline-block' : 'none';
                elements.callApiBtn.disabled = show;
            },

            updateResult(content) {
                elements.result.textContent = content;
            },

            clearInput() {
                elements.input.value = '';
            },

            initEventListeners() {
                // APIè°ƒç”¨
                elements.callApiBtn.addEventListener('click', async () => {
                    if (!elements.input.value.trim()) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆç—‡çŠ¶æè¿°');
                        return;
                    }

                    try {
                        uiController.toggleLoading(true);
                        const reader = await apiService.fetchPrescription(elements.input.value.trim());
                        const finalResult = await apiService.processStream(reader, (partialResult) => {
                            uiController.updateResult(partialResult);
                        });
                        
                        const newRecord = recordManager.addRecord(elements.input.value.trim(), finalResult);
                        recordManager.renderRecords();
                    uiController.clearInput();
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            uiController.updateResult('è¯·æ±‚å·²ç»ˆæ­¢');
                        } else {
                            console.error('API Error:', error);
                            uiController.updateResult(`é”™è¯¯: ${error.message}`);
                        }
                    } finally {
                        uiController.toggleLoading(false);
                    }
                });

                // ç»ˆæ­¢è¯·æ±‚
                elements.stopApiBtn.addEventListener('click', () => {
                    if (state.controller) {
                        state.controller.abort();
                    }
                });

                // å¯¼å‡ºæ—¥å¿—
                elements.exportBtn.addEventListener('click', () => {
                    const content = state.records
                        .map((r, i) => `è®°å½• ${i + 1}:\næ—¶é—´: ${utils.formatTimestamp(new Date(r.timestamp))}\nç—‡çŠ¶: ${r.symptoms}\nç»æ–¹:\n${r.solution}\n${'-'.repeat(50)}\n`)
                        .join('\n');

                    try {
                        const blob = new Blob([content], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `ç»æ–¹è®°å½•_${utils.formatTimestamp(new Date())}.log`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('å¯¼å‡ºå¤±è´¥:', error);
                        alert('æ—¥å¿—å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });

                // åŠ¨æ€å…ƒç´ äº‹ä»¶å§”æ‰˜
                elements.recordList.addEventListener('click', (e) => {
                    const recordItem = e.target.closest('.md-record-item');
                    
                    // åˆ é™¤æ“ä½œ
                    if (e.target.classList.contains('md-delete-btn')) {
                        const recordId = parseInt(recordItem.dataset.id);
                        recordManager.deleteRecord(recordId);
                        recordItem.remove();
                        return;
                    }

                    // å±•å¼€/æ”¶èµ·
                    if (recordItem) {
                        recordItem.classList.toggle('expanded');
                    }
                });
            }
        };

        // åˆå§‹åŒ–åº”ç”¨
        return {
            init() {
                recordManager.renderRecords();
                uiController.initEventListeners();
            }
        };
    })();

    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', App.init);
</script>
    
</body>

</html>
